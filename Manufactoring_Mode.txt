*** Settings ***
Suite Setup       Runkeywords    Stop cWLC Simulator
...               AND    Define Tunnel Protocol
...               AND    Setup Log Directory
...               AND    Start SSL Server    ${cWLC_IP_Address}    ${Tunnel Port}    protocol=Tunnel    keystore=${KEYSTORE}    timeout=120
...               AND    Read RSA Public key from file
...               AND    calculate Priveledge and Root password
...               AND    bring AP up after reboot or \ link restore    # Runkeywords | Stop cWLC Simulator | AND | Define Tunnel Protocol | AND | Setup Log Directory | AND | Start SSL Server | ${cWLC_IP_Address} | ${Tunnel Port} | protocol=Tunnel | keystore=${KEYSTORE} | timeout=120 | AND | Read RSA Public key from file | AND | Accept Connection | AND | Server Receives Binary | AND | Get AP prompt
Suite Teardown    Run Keywords    Close all connections
...               AND    Reset Rammbock
...               AND    sleep    10s
...               AND    start cWLC Simulator
Test Teardown
Library           Rammbock
Resource          ../../Common/Keywords/Common_Keywords.txt
Resource          ../../../Common/Keywords/COMMON_nwam_keywords.txt


*** Variables ***
${Factory_Default_IP}    192.168.10.1

*** Test Cases ***
Manufactoring Mode
    ${HB_Timer_Value}    Get NWAM Timer value from AP    ${HB_Init_Timer}
    rebootAP
    ${Reg_Req}    ${Config_res}=    Config download on AP    ${config_file}    @{ssid}
    : FOR    ${index}    IN RANGE    0    2
    \    ${message}=    Wait Until Keyword Succeeds    ${HB_Timer_Value}    0.1s    Receive Heartbeat    ${HB_Timer_Value}
    \    ...    ${AP_name}
    \    Log to console    Received Heartbeat for ${index} time
    \    Send Heartbeat Response    ${AP_name}
    sleep    5s
    Enable Manufacturing mode    enable
    Verify If AP is rebooting
    ${AP_IP_ADD}    Set Variable    ${AP_IP_ADDRESS}
    ${AP_IP_ADDRESS}    Set Variable    ${Factory_Default_IP}
    Set Suite Variable    ${AP_IP_ADD}
    Verify If AP is up
    Enable Root Access
    Enable Logs from CLI    30
    Verify manufacturing mode    1
    Execute Test-Radio command
    Verify Factory SSIDs are transmitting
    Log To Console    ----Sleeping for 5min to check SSIDs are not transmitting----
    sleep    300s
    Verify Factory SSIDs are not transmitting
    [Teardown]    Run Keywords    Transfer All AP Logs
    ...    AND    Disable Manufacturing Mode
    ...    AND    Verify If AP is rebooting
    ...    AND    ${AP_IP_ADDRESS}    Set Variable    ${EMPTY}
    ...    AND    ${AP_IP_ADDRESS}    Set Variable    ${AP_IP_ADD}
    ...    AND    Config download on AP    ${config_file}    @{ssid}    ${EMPTY}

*** Keywords ***
Enable Manufacturing mode
    [Arguments]    ${enable}
    Switch Connection    CLI
    Write    msetm-enable
    ${output}    Read Until    [Yes/No]
    Should Contain    ${output}    This command shouldn't be attempted.This will bring down the Access Point and erase all the configuration. Do you really want to continue? [Yes/No]
    Write    YYYYYEEEEESSSSS
    Read Until Prompt
    SSHLibrary.Close All Connections

Verify manufacturing mode
    [Arguments]    ${value}
    Switch Connection    CLI
    Write    show env
    ${show_env}    Read Until Prompt
    Should Contain    ${show_env}    ManufactureMode=${value}

Execute Test-Radio command
    Switch Connection    CLI
    Write    test-radio 1
    ${output}    Read Until    [Yes/No]
    Should Contain    ${output}    This command shouldn't be attempted.This will bring down the Access Point and erase all the configuration. Do you really want to continue? [Yes/No]
    Write    YYYYYEEEEESSSSS

Verify Factory SSIDs are transmitting
    Switch Connection    root
    Write    iwconfig
    ${after_testradio}    Read Until Prompt
    Should Contain    ${after_testradio}    ${AP_SERIAL_NUMBER}-2.4GHz
    Should Contain    ${after_testradio}    ${AP_SERIAL_NUMBER}-5GHz

Verify Factory SSIDs are not transmitting
    Switch Connection    root
    Write    iwconfig
    ${after_testradio}    Read Until Prompt
    Should Not Contain    ${after_testradio}    ${AP_SERIAL_NUMBER}-2.4GHz
    Should Not Contain    ${after_testradio}    ${AP_SERIAL_NUMBER}-5GHz

Disable Manufacturing Mode
    Switch Connection    CLI
    Write    msetm-disable
    ${output}    Read Until    [Yes/No]
    Should Contain    ${output}    Do you really want to continue? [Yes/No]
    Write    YYYYYEEEEESSSSS
    Read Until Prompt
    SSHLibrary.Close All Connections
